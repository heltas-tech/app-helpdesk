<div class="dashboard-container">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Cargando tu dashboard...</p>
    </div>
  }

  <!-- Dashboard Content -->
  @if (!isLoading) {
    <!-- DEBUG TEMPORAL - QUITAR LUEGO -->
    <div class="debug-banner" (click)="debugDashboard()">
      <mat-icon>bug_report</mat-icon>
      <span>DEBUG: Click aqu√≠ para ver datos cargados</span>
    </div>

    <!-- Header de Bienvenida -->
    <div class="welcome-header">
      <div class="welcome-content">
        <div class="user-info">
          <div class="avatar">
            <mat-icon class="avatar-icon">person</mat-icon>
          </div>
          <div class="user-details">
            <h1>¬°Bienvenido, {{usuario?.nombre_usuario || 'Cliente'}}! üëã</h1>
            <p>Resumen de tus tickets y actividad de soporte</p>
            <div class="user-stats">
              <span class="stat-item">
                <mat-icon>today</mat-icon>
                {{ today | date:'fullDate' }}
              </span>
              <span class="stat-item">
                <mat-icon>support_agent</mat-icon>
                {{ metricas.ticketsEnProceso }} tickets en proceso
              </span>
            </div>
          </div>
        </div>
        <div class="header-actions">
          <button mat-raised-button color="primary" class="action-btn primary" routerLink="/crear-ticket">
            <mat-icon>add</mat-icon>
            Nuevo Ticket
          </button>
          <button mat-stroked-button class="action-btn secondary" (click)="refreshData()">
            <mat-icon>refresh</mat-icon>
            Actualizar
          </button>
        </div>
      </div>
    </div>

    <!-- M√©tricas Principales -->
    <div class="metrics-grid">
      <mat-card class="metric-card primary">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="metric-data">
            <div class="metric-number">{{metricas.ticketsAbiertos}}</div>
            <div class="metric-label">Tickets Abiertos</div>
            <div class="metric-trend">Pendientes de asignar</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card success">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <div class="metric-data">
            <div class="metric-number">{{metricas.ticketsResueltos}}</div>
            <div class="metric-label">Tickets Resueltos</div>
            <div class="metric-trend">{{metricas.satisfaccion}}% satisfacci√≥n</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card warning">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>autorenew</mat-icon>
          </div>
          <div class="metric-data">
            <div class="metric-number">{{metricas.ticketsEnProceso}}</div>
            <div class="metric-label">En Proceso</div>
            <div class="metric-trend">Con t√©cnico asignado</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="metric-card danger">
        <mat-card-content>
          <div class="metric-icon">
            <mat-icon>priority_high</mat-icon>
          </div>
          <div class="metric-data">
            <div class="metric-number">{{metricas.ticketsUrgentes}}</div>
            <div class="metric-label">Tickets Urgentes</div>
            <div class="metric-trend">Prioridad alta</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- M√©tricas Secundarias -->
    <div class="secondary-metrics">
      <mat-card class="secondary-card">
        <mat-card-content>
          <div class="secondary-icon">
            <mat-icon>schedule</mat-icon>
          </div>
          <div class="secondary-data">
            <div class="secondary-value">{{metricas.tiempoPromedio}}</div>
            <div class="secondary-label">Resoluci√≥n Promedio</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="secondary-card">
        <mat-card-content>
          <div class="secondary-icon">
            <mat-icon>timer</mat-icon>
          </div>
          <div class="secondary-data">
            <div class="secondary-value">{{metricas.tiempoRespuesta}}</div>
            <div class="secondary-label">Respuesta Promedio</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="secondary-card">
        <mat-card-content>
          <div class="secondary-icon">
            <mat-icon>sentiment_very_satisfied</mat-icon>
          </div>
          <div class="secondary-data">
            <div class="secondary-value">{{metricas.satisfaccion}}%</div>
            <div class="secondary-label">Satisfacci√≥n</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="secondary-card">
        <mat-card-content>
          <div class="secondary-icon">
            <mat-icon>verified</mat-icon>
          </div>
          <div class="secondary-data">
            <div class="secondary-value">{{metricas.slaCumplido}}%</div>
            <div class="secondary-label">SLA Cumplido</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Contenido Principal -->
    <div class="main-content">
      <!-- Columna Izquierda - Gr√°ficos -->
      <div class="charts-column">
        <!-- Gr√°fico de Donut -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>pie_chart</mat-icon>
              Distribuci√≥n de Mis Tickets
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <apx-chart
              [series]="donutChartOptions.series"
              [chart]="donutChartOptions.chart"
              [labels]="donutChartOptions.labels"
              [responsive]="donutChartOptions.responsive"
              [legend]="donutChartOptions.legend"
              [colors]="donutChartOptions.colors"
              [title]="donutChartOptions.title"
              [plotOptions]="donutChartOptions.plotOptions"
              [dataLabels]="donutChartOptions.dataLabels">
            </apx-chart>
          </mat-card-content>
        </mat-card>

        <!-- Gr√°fico de Barras -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>bar_chart</mat-icon>
              Mis Tickets por Mes
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <apx-chart
              [series]="barChartOptions.series"
              [chart]="barChartOptions.chart"
              [xaxis]="barChartOptions.xaxis"
              [yaxis]="barChartOptions.yaxis"
              [title]="barChartOptions.title"
              [plotOptions]="barChartOptions.plotOptions"
              [dataLabels]="barChartOptions.dataLabels"
              [fill]="barChartOptions.fill">
            </apx-chart>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Columna Derecha - Sidebar -->
      <div class="sidebar-column">
        <!-- Satisfacci√≥n -->
        <mat-card class="radial-card">
          <mat-card-content>
            <apx-chart
              [series]="radialChartOptions.series"
              [chart]="radialChartOptions.chart"
              [plotOptions]="radialChartOptions.plotOptions"
              [labels]="radialChartOptions.labels"
              [colors]="radialChartOptions.colors"
              [title]="radialChartOptions.title">
            </apx-chart>
          </mat-card-content>
        </mat-card>

        <!-- Tickets Recientes -->
        <mat-card class="tickets-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>list_alt</mat-icon>
              Mis Tickets Recientes
              <mat-chip class="badge-chip" color="primary" selected>{{ticketsRecientes.length}}</mat-chip>
            </mat-card-title>
            <button mat-icon-button routerLink="/mis-tickets">
              <mat-icon>open_in_new</mat-icon>
            </button>
          </mat-card-header>
          <mat-card-content>
            @if (ticketsRecientes.length > 0) {
              <mat-list class="tickets-list">
                @for (ticket of ticketsRecientes; track ticket.id) {
                  <mat-list-item class="ticket-item">
                    <div matListItemIcon class="ticket-icon">
                      <mat-icon [color]="getPrioridadColor(ticket.prioridad)">
                        {{ticket.prioridad === 'Cr√≠tica' || ticket.prioridad === 'Alta' ? 'priority_high' : 'low_priority'}}
                      </mat-icon>
                    </div>
                    <div matListItemTitle class="ticket-title">
                      <span class="ticket-id">{{ticket.id}}</span>
                      {{ticket.titulo}}
                    </div>
                    <div matListItemLine class="ticket-meta">
                      <mat-chip [color]="getEstadoColor(ticket.estado)" selected class="status-chip">
                        {{ticket.estado}}
                      </mat-chip>
                      <span class="ticket-category">{{ticket.categoria}}</span>
                      <span class="ticket-date">{{ticket.fecha | date:'shortDate'}}</span>
                    </div>
                    <div matListItemLine class="ticket-time">
                      <mat-icon>schedule</mat-icon>
                      {{ticket.tiempoTranscurrido}}
                    </div>
                  </mat-list-item>
                }
              </mat-list>
            } @else {
              <div class="empty-state">
                <mat-icon>inbox</mat-icon>
                <p>No tienes tickets a√∫n</p>
                <button mat-raised-button color="primary" routerLink="/crear-ticket">
                  Crear mi primer ticket
                </button>
              </div>
            }
          </mat-card-content>
          @if (ticketsRecientes.length > 0) {
            <mat-card-actions>
              <button mat-button routerLink="/mis-tickets" class="view-all-btn">
                <mat-icon>visibility</mat-icon>
                Ver Todos mis Tickets
              </button>
            </mat-card-actions>
          }
        </mat-card>

        <!-- Notificaciones -->
        <mat-card class="notifications-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>notifications</mat-icon>
              Mis Notificaciones
              <mat-chip class="badge-chip" color="warn" selected>{{notificaciones.length}}</mat-chip>
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="notifications-list">
              @for (notif of notificaciones; track notif.mensaje) {
                <div class="notification-item" [class]="'notification-' + notif.tipo">
                  <div class="notification-icon">
                    <mat-icon [color]="getNotificacionColor(notif.tipo)">
                      {{getNotificacionIcon(notif.tipo)}}
                    </mat-icon>
                  </div>
                  <div class="notification-content">
                    <div class="notification-message">{{notif.mensaje}}</div>
                    <div class="notification-time">{{notif.fecha}}</div>
                  </div>
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Acciones R√°pidas -->
        <mat-card class="actions-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>flash_on</mat-icon>
              Acciones R√°pidas
            </mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="actions-grid">
              <button mat-stroked-button routerLink="/crear-ticket" class="action-button">
                <mat-icon>add_circle</mat-icon>
                <span>Nuevo Ticket</span>
              </button>
              <button mat-stroked-button routerLink="/mis-tickets" class="action-button">
                <mat-icon>list_alt</mat-icon>
                <span>Mis Tickets</span>
              </button>
              <button mat-stroked-button routerLink="/base-conocimiento" class="action-button">
                <mat-icon>menu_book</mat-icon>
                <span>Buscar Soluciones</span>
              </button>
              <button mat-stroked-button (click)="refreshData()" class="action-button">
                <mat-icon>refresh</mat-icon>
                <span>Actualizar</span>
              </button>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  }
</div>