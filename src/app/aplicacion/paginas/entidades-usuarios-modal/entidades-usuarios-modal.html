<div class="modal-container">
  <div class="card">
    
    <!-- Título - SIEMPRE VISIBLE -->
    <a class="login">{{ isEditMode ? 'EDITAR ASIGNACIÓN' : 'NUEVA ASIGNACIÓN' }}</a>

    <form [formGroup]="form" class="form-content">
      
      <!-- Selección de Usuario -->
      <div class="inputBox">
        <select 
          formControlName="usuarioId"
          required
          [class.has-value]="usuarioId?.value"
          [class.invalid]="usuarioId?.invalid && usuarioId?.touched">
          <option value=""></option>
          <option *ngFor="let usuario of usuarios" [value]="usuario.id">
            {{ usuario.nombre_usuario }} ({{ usuario.correo_electronico }})
          </option>
        </select>
        <span>Usuario CLIENTE</span>
        
        <!-- Loading -->
        <div *ngIf="cargandoUsuarios" class="loading-indicator">
          <mat-icon class="loading-icon">refresh</mat-icon>
          <span>Cargando usuarios CLIENTE...</span>
        </div>

        @if (usuarioId?.invalid && usuarioId?.touched) {
          <div class="error-message">
            {{ getErrorMessage('usuarioId') }}
          </div>
        }
      </div>

      <!-- Información del usuario seleccionado -->
      @if (getUsuarioSeleccionado()) {
        <div class="info-card" [class.inactive]="isUsuarioInactivo()">
          <div class="info-header">
            <mat-icon class="info-icon">person</mat-icon>
            <span class="info-title">Información del Usuario</span>
          </div>
          <div class="info-content">
            <div class="info-row">
              <strong>Email:</strong> {{ getUsuarioSeleccionado()?.correo_electronico }}
            </div>
            <div class="info-row">
              <strong>Teléfono:</strong> {{ getUsuarioSeleccionado()?.telefono || 'No especificado' }}
            </div>
            <div class="info-row">
              <strong>Rol:</strong> 
              <span class="role-badge">{{ getUsuarioSeleccionado()?.rol }}</span>
            </div>
            <div class="info-row">
              <strong>Estado:</strong> 
              <span [class]="getUsuarioSeleccionado()?.activo ? 'status-active' : 'status-inactive'">
                {{ getUsuarioSeleccionado()?.activo ? 'Activo' : 'Inactivo' }}
              </span>
            </div>
          </div>
        </div>
      }

      <!-- Selección de Entidad -->
      <div class="inputBox">
        <select 
          formControlName="entidadId"
          required
          [class.has-value]="entidadId?.value"
          [class.invalid]="entidadId?.invalid && entidadId?.touched">
          <option value=""></option>
          <option *ngFor="let entidad of entidades" [value]="entidad.id">
            {{ entidad.denominacion }} ({{ entidad.nit }})
          </option>
        </select>
        <span>Entidad</span>
        
        <!-- Loading -->
        <div *ngIf="cargandoEntidades" class="loading-indicator">
          <mat-icon class="loading-icon">refresh</mat-icon>
          <span>Cargando entidades...</span>
        </div>

        @if (entidadId?.invalid && entidadId?.touched) {
          <div class="error-message">
            {{ getErrorMessage('entidadId') }}
          </div>
        }
      </div>

      <!-- Información de la entidad seleccionada -->
      @if (getEntidadSeleccionada()) {
        <div class="info-card" [class.inactive]="isEntidadInactiva()">
          <div class="info-header">
            <mat-icon class="info-icon">business</mat-icon>
            <span class="info-title">Información de la Entidad</span>
          </div>
          <div class="info-content">
            <div class="info-row">
              <strong>NIT:</strong> {{ getEntidadSeleccionada()?.nit }}
            </div>
            <div class="info-row">
              <strong>Estado:</strong> 
              <span [class]="getEntidadSeleccionada()?.estado ? 'status-active' : 'status-inactive'">
                {{ getEntidadSeleccionada()?.estado ? 'Activa' : 'Inactiva' }}
              </span>
            </div>
          </div>
        </div>
      }

      <!-- Campo Cargo -->
      <div class="inputBox">
        <input 
          type="text"
          formControlName="cargo"
          required
          placeholder=" "
          [class.has-value]="cargo?.value"
          [class.invalid]="cargo?.invalid && cargo?.touched">
        <span>Cargo en la Entidad</span>
        
        @if (cargo?.invalid && cargo?.touched) {
          <div class="error-message">
            {{ getErrorMessage('cargo') }}
          </div>
        }

        <!-- Sugerencias de cargo -->
        <div class="suggestions">
          <span class="suggestions-label"></span>
          <div class="suggestions-buttons">
            <button 
              *ngFor="let sugerencia of ['Gerente', 'Coordinador', 'Analista', 'Supervisor']"
              type="button"
              (click)="form.patchValue({ cargo: sugerencia })"
              class="suggestion-btn">
              {{ sugerencia }}
            </button>
          </div>
        </div>
      </div>

      <!-- Estado -->
      <div class="toggle-container">
        <label class="toggle-label">Estado de la asignación:</label>
        <mat-slide-toggle 
          formControlName="activo"
          color="primary"
          class="custom-toggle">
          {{ form.get('activo')?.value ? 'Activa' : 'Inactiva' }}
        </mat-slide-toggle>
      </div>

      <input type="hidden" formControlName="id">

    </form>

    <!-- Mensaje de validación general -->
    @if (form.invalid && form.touched) {
      <div class="warning-message">
        <mat-icon class="warning-icon">warning</mat-icon>
        <span class="warning-text">Completa todos los campos obligatorios correctamente</span>
      </div>
    }

    <!-- Botones - SIEMPRE VISIBLES -->
    <div class="button-container">
      <button 
        type="button"
        (click)="cancel()"
        class="cancel-btn">
        Cancelar
      </button>
      
      <button 
        type="button"
        (click)="save()"
        [disabled]="form.invalid"
        class="enter-btn"
        [class.disabled]="form.invalid">
        {{ isEditMode ? 'ACTUALIZAR' : 'CREAR' }}
      </button>
    </div>

  </div>
</div>