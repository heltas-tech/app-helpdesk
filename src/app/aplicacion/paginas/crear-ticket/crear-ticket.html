<div class="container mx-auto p-6 max-w-4xl">
  <h1 class="text-2xl font-bold text-gray-800 mb-6">Crear Nuevo Ticket</h1>

  <!-- Formulario -->
  <div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <!-- Asunto -->
    <mat-form-field class="w-full mb-4">
      <mat-label>Asunto del Ticket</mat-label>
      <input matInput 
             [(ngModel)]="ticketData.titulo" 
             placeholder="Describe brevemente el problema"
             maxlength="200">
      <mat-hint align="end">{{ticketData.titulo?.length || 0}}/200</mat-hint>
    </mat-form-field>

    <!-- Categor√≠a y Subcategor√≠a -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <mat-form-field class="w-full">
        <mat-label>Categor√≠a *</mat-label>
        <mat-select [(ngModel)]="ticketData.categoria_id" 
                   (selectionChange)="onCategoriaChange()"
                   required>
          <mat-option>-- Seleccionar categor√≠a --</mat-option>
          <mat-option *ngFor="let categoria of categorias" [value]="categoria.id">
            {{ categoria.nombre }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="!ticketData.categoria_id">La categor√≠a es obligatoria</mat-error>
      </mat-form-field>

      <mat-form-field class="w-full">
        <mat-label>Subcategor√≠a</mat-label>
        <mat-select [(ngModel)]="ticketData.subcategoria_id" 
                   [disabled]="!ticketData.categoria_id">
          <mat-option>-- Seleccionar subcategor√≠a --</mat-option>
          <mat-option *ngFor="let subcategoria of getSubcategoriasFiltradas()" [value]="subcategoria.id">
            {{ subcategoria.nombre }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Editor de Descripci√≥n -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Descripci√≥n Detallada *
      </label>
      <app-summernote-editor 
        [initialContent]="ticketData.descripcion"
        (contentChange)="onEditorContentChange($event)"
        (imageUpload)="onEditorImageUpload($event)">
      </app-summernote-editor>
      <div class="text-xs text-gray-500 mt-1 flex items-center">
        <mat-icon class="text-sm mr-1">info</mat-icon>
        üí° Puedes pegar im√°genes directamente con Ctrl+V. Se guardar√°n como archivos adjuntos.
      </div>
    </div>

    <!-- Archivos Adjuntos -->
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <label class="block text-sm font-medium text-gray-700">
          Archivos Adjuntos
        </label>
        <span class="text-xs text-gray-500">
          {{archivos.length}} archivo(s) seleccionado(s)
        </span>
      </div>
      
      <!-- Input para agregar archivos -->
      <div class="mb-4 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
        <input type="file" 
               #fileInput 
               multiple 
               (change)="onFileSelected($event)" 
               class="hidden"
               accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.zip,.rar,.txt">
        
        <div class="flex flex-col items-center justify-center space-y-2">
          <mat-icon class="text-gray-400 text-4xl">cloud_upload</mat-icon>
          <p class="text-sm text-gray-600">
            Arrastra archivos aqu√≠ o haz clic para seleccionar
          </p>
          <button mat-stroked-button 
                  color="primary" 
                  (click)="fileInput.click()"
                  type="button">
            <mat-icon>attach_file</mat-icon>
            Seleccionar Archivos
          </button>
          <p class="text-xs text-gray-500">
            Formatos permitidos: im√°genes, PDF, Word, Excel, ZIP. M√°ximo 50MB por archivo.
          </p>
        </div>
      </div>

      <!-- Lista de archivos por subir -->
      <div *ngIf="archivos.length > 0" class="space-y-3">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Archivos a adjuntar:</h3>
        
        <mat-card *ngFor="let archivo of archivos; let i = index" 
                 class="p-3 hover:shadow-md transition-shadow duration-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3 flex-1 min-w-0">
              <mat-icon class="text-gray-500 flex-shrink-0" 
                       [class.text-green-500]="getFileIcon(archivo.name) === 'image'"
                       [class.text-red-500]="getFileIcon(archivo.name) === 'picture_as_pdf'"
                       [class.text-blue-500]="getFileIcon(archivo.name) === 'description'">
                {{ getFileIcon(archivo.name) }}
              </mat-icon>
              <div class="min-w-0 flex-1">
                <div class="text-sm font-medium truncate" [title]="archivo.name">
                  {{ archivo.name }}
                </div>
                <div class="text-xs text-gray-500 flex items-center space-x-2">
                  <span>{{ formatFileSize(archivo.size) }}</span>
                  <span>‚Ä¢</span>
                  <span>{{ archivo.type || 'Tipo desconocido' }}</span>
                </div>
              </div>
            </div>
            <button mat-icon-button 
                    color="warn" 
                    (click)="eliminarArchivo(i)"
                    class="flex-shrink-0"
                    matTooltip="Eliminar archivo">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </mat-card>
      </div>

      <!-- Archivos subiendo -->
      <div *ngIf="archivosSubiendo.length > 0" class="mt-4 space-y-3">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Subiendo archivos:</h3>
        <div *ngFor="let archivo of archivosSubiendo" class="bg-gray-50 rounded-lg p-3">
          <div class="flex items-center justify-between text-sm mb-2">
            <div class="flex items-center space-x-2">
              <mat-icon class="text-gray-500 text-sm">cloud_upload</mat-icon>
              <span class="font-medium">{{ archivo.nombre }}</span>
            </div>
            <span class="font-semibold text-blue-600">{{ archivo.progreso }}%</span>
          </div>
          <mat-progress-bar mode="determinate" 
                           [value]="archivo.progreso"
                           color="primary">
          </mat-progress-bar>
        </div>
      </div>

      <!-- Archivos ya subidos -->
      <div *ngIf="archivosSubidos.length > 0" class="mt-4 space-y-2">
        <h3 class="text-sm font-medium text-green-600 mb-2">Archivos subidos exitosamente:</h3>
        <div *ngFor="let archivo of archivosSubidos" class="flex items-center space-x-2 text-sm text-green-600">
          <mat-icon class="text-sm">check_circle</mat-icon>
          <span>{{ archivo.nombreOriginal }}</span>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n de Validaci√≥n -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
      <div class="flex items-start space-x-2">
        <mat-icon class="text-yellow-600 flex-shrink-0">warning</mat-icon>
        <div class="text-sm text-yellow-700">
          <p class="font-medium">Antes de enviar verifica:</p>
          <ul class="list-disc list-inside mt-1 space-y-1">
            <li>El asunto describe claramente el problema</li>
            <li>La descripci√≥n incluye todos los detalles necesarios</li>
            <li>Has seleccionado la categor√≠a correcta</li>
            <li>Los archivos adjuntos son los correctos</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
      <button mat-stroked-button 
              color="basic" 
              (click)="cancelar()" 
              [disabled]="enviando"
              type="button"
              class="min-w-24">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
      
      <button mat-raised-button 
              color="primary" 
              (click)="crearTicket()" 
              [disabled]="!isFormValid()"
              type="button"
              class="min-w-32"
              matTooltip="Crear nuevo ticket con la informaci√≥n proporcionada">
        <mat-icon *ngIf="enviando" class="animate-spin">autorenew</mat-icon>
        <mat-icon *ngIf="!enviando">add_task</mat-icon>
        {{ enviando ? 'Creando Ticket...' : 'Crear Ticket' }}
      </button>
    </div>
  </div>

  <!-- Informaci√≥n del Sistema -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Informaci√≥n del Contrato -->
    <div *ngIf="contratoActivo" class="bg-blue-50 rounded-lg p-4 border border-blue-200">
      <div class="flex items-center space-x-2 mb-2">
        <mat-icon class="text-blue-600">description</mat-icon>
        <h3 class="font-medium text-blue-800">Informaci√≥n del Contrato</h3>
      </div>
      <div class="space-y-1 text-sm text-blue-700">
        <div class="flex justify-between">
          <span>Contrato:</span>
          <span class="font-medium">{{ contratoActivo.nombre }}</span>
        </div>
        <div class="flex justify-between">
          <span>Estado:</span>
          <span class="font-medium">{{ contratoActivo.estado_contrato }}</span>
        </div>
        <div class="flex justify-between">
          <span>Prioridad:</span>
          <span class="font-medium" 
                [class.text-green-600]="contratoActivo.prioridad"
                [class.text-red-600]="!contratoActivo.prioridad">
            {{ contratoActivo.prioridad?.nombre || 'No asignada' }}
          </span>
        </div>
        <div *ngIf="contratoActivo.fecha_inicio" class="flex justify-between">
          <span>Inicio:</span>
          <span class="font-medium">{{ contratoActivo.fecha_inicio | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
    </div>

    <!-- Informaci√≥n de la Empresa -->
    <div *ngIf="entidadUsuario" class="bg-green-50 rounded-lg p-4 border border-green-200">
      <div class="flex items-center space-x-2 mb-2">
        <mat-icon class="text-green-600">business</mat-icon>
        <h3 class="font-medium text-green-800">Informaci√≥n de la Empresa</h3>
      </div>
      <div class="space-y-1 text-sm text-green-700">
        <div class="flex justify-between">
          <span>Empresa:</span>
          <span class="font-medium">{{ entidadUsuario.entidad?.nombre || 'No especificada' }}</span>
        </div>
        <div class="flex justify-between">
          <span>RUC:</span>
          <span class="font-medium">{{ entidadUsuario.entidad?.ruc || 'No especificado' }}</span>
        </div>
        <div class="flex justify-between">
          <span>Estado:</span>
          <span class="font-medium" 
                [class.text-green-600]="entidadUsuario.activo"
                [class.text-red-600]="!entidadUsuario.activo">
            {{ entidadUsuario.activo ? 'Activo' : 'Inactivo' }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Estado de Carga -->
  <div *ngIf="enviando" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
      <div class="flex flex-col items-center space-y-4">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
        <div class="text-center">
          <h3 class="text-lg font-medium text-gray-900">Creando Ticket</h3>
          <p class="text-sm text-gray-600 mt-1">
            Estamos procesando tu solicitud y subiendo los archivos adjuntos...
          </p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" 
               [style.width]="(archivosSubidos.length / archivos.length * 100) + '%'">
          </div>
        </div>
        <p class="text-xs text-gray-500">
          {{ archivosSubidos.length }} de {{ archivos.length }} archivos subidos
        </p>
      </div>
    </div>
  </div>
</div>