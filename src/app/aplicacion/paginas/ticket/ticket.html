<div class="tickets-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="title">Gesti√≥n de Tickets</h1>
        <p class="subtitle">Administraci√≥n completa del sistema de tickets</p>
      </div>
      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">Total:</span>
          <span class="stat-value">{{dataSource.filteredData.length}}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros R√°pidos -->
  <div class="filters-section">
    <div class="quick-filters">
      <div class="filter-group">
        <label class="filter-label">Filtros R√°pidos</label>
        <div class="quick-filter-buttons">
          <button 
            class="quick-filter-btn"
            [class.active]="filtrosEspeciales.sinAsignar"
            (click)="aplicarFiltroEspecial('sinAsignar')">
            <mat-icon>person_off</mat-icon>
            Sin Asignar
          </button>
          <button 
            class="quick-filter-btn urgent"
            [class.active]="filtrosEspeciales.urgentes"
            (click)="aplicarFiltroEspecial('urgentes')">
            <mat-icon>warning</mat-icon>
            Urgentes
          </button>
          <button 
            class="quick-filter-btn warning"
            [class.active]="filtrosEspeciales.proximosVencer"
            (click)="aplicarFiltroEspecial('proximosVencer')">
            <mat-icon>schedule</mat-icon>
            Pr√≥ximos a Vencer
          </button>
          <button 
            class="quick-filter-btn danger"
            [class.active]="filtrosEspeciales.vencidos"
            (click)="aplicarFiltroEspecial('vencidos')">
            <mat-icon>error</mat-icon>
            Vencidos
          </button>
          <button 
            class="quick-filter-btn success"
            [class.active]="filtrosEspeciales.resueltosHoy"
            (click)="aplicarFiltroEspecial('resueltosHoy')">
            <mat-icon>today</mat-icon>
            Resueltos Hoy
          </button>
        </div>
      </div>
    </div>

    <!-- Filtros Avanzados -->
    <div class="advanced-filters">
      <div class="filter-row">
        <!-- B√∫squeda -->
        <div class="filter-item search-item">
          <label class="filter-label">Buscar</label>
          <div class="search-container">
            <input 
              type="text" 
              [(ngModel)]="textoBusqueda"
              (input)="aplicarTodosLosFiltros()"
              placeholder="Buscar tickets..." 
              class="search-input">
            <mat-icon class="search-icon">search</mat-icon>
            <button 
              *ngIf="textoBusqueda"
              (click)="textoBusqueda = ''; aplicarTodosLosFiltros()"
              class="clear-search">
              <mat-icon>clear</mat-icon>
            </button>
          </div>
        </div>

        <!-- Estado General -->
        <div class="filter-item">
          <label class="filter-label">Estado</label>
          <select 
            [(ngModel)]="filtroEstado" 
            (change)="cargarTickets()"
            class="filter-select">
            <option value="activos">Activos</option>
            <option value="eliminados">Eliminados</option>
            <option value="todos">Todos</option>
          </select>
        </div>

        <!-- Estado Ticket -->
        <div class="filter-item">
          <label class="filter-label">Estado Ticket</label>
          <select 
            [(ngModel)]="filtroEstadoTicket" 
            (change)="aplicarTodosLosFiltros()"
            class="filter-select">
            <option value="todos">Todos los estados</option>
            <option value="NUEVO">Nuevo</option>
            <option value="EN_PROCESO">En Proceso</option>
            <option value="RESUELTO">Resuelto</option>
            <option value="REABIERTO">Reabierto</option>
            <option value="CERRADO">Cerrado</option>
          </select>
        </div>

        <!-- Prioridad -->
        <div class="filter-item">
          <label class="filter-label">Prioridad</label>
          <select 
            [(ngModel)]="filtroPrioridad" 
            (change)="aplicarTodosLosFiltros()"
            class="filter-select">
            <option value="todas">Todas las prioridades</option>
            <option *ngFor="let prioridad of prioridades" [value]="prioridad.id">
              {{prioridad.nombre}}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-row">
        <!-- T√©cnico -->
        <div class="filter-item">
          <label class="filter-label">T√©cnico</label>
          <select 
            [(ngModel)]="filtroTecnico" 
            (change)="aplicarTodosLosFiltros()"
            class="filter-select">
            <option value="todos">Todos los t√©cnicos</option>
            <option value="sin-asignar">Sin asignar</option>
            <option *ngFor="let tecnico of tecnicos" [value]="tecnico.id">
              {{tecnico.nombre_usuario}}
            </option>
          </select>
        </div>

        <!-- Categor√≠a -->
        <div class="filter-item">
          <label class="filter-label">Categor√≠a</label>
          <select 
            [(ngModel)]="filtroCategoria" 
            (change)="aplicarTodosLosFiltros()"
            class="filter-select">
            <option value="todas">Todas las categor√≠as</option>
            <option *ngFor="let categoria of categorias" [value]="categoria.id">
              {{categoria.nombre}}
            </option>
          </select>
        </div>

        <!-- Botones de acci√≥n -->
        <div class="filter-actions">
          <button 
            (click)="limpiarFiltros()"
            class="btn-secondary">
            <mat-icon>refresh</mat-icon>
            Limpiar
          </button>
          <button 
            (click)="exportExcel()" 
            class="btn-success">
            <mat-icon>description</mat-icon>
            Excel
          </button>
          <button 
            (click)="exportPDF()" 
            class="btn-danger">
            <mat-icon>picture_as_pdf</mat-icon>
            PDF
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de Tickets -->
  <div class="table-container">
    <table mat-table [dataSource]="dataSource" class="tickets-table">
      
      <!-- Columna ID -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let element" class="id-cell">
          <div class="id-content">
            <span class="id-number">#{{element.id}}</span>
            <span 
              *ngIf="element.veces_reabierto && element.veces_reabierto > 0"
              class="reopen-badge"
              [matTooltip]="'Reabierto ' + element.veces_reabierto + ' veces'">
              <mat-icon>refresh</mat-icon>
              {{element.veces_reabierto}}
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Columna T√≠tulo -->
      <ng-container matColumnDef="titulo">
        <th mat-header-cell *matHeaderCellDef>T√≠tulo</th>
        <td mat-cell *matCellDef="let element" class="title-cell">
          <div class="title-content">
            <div class="title-text">{{ element.titulo }}</div>
            <div class="title-meta">
              <mat-icon>schedule</mat-icon>
              {{ getTiempoTranscurrido(element.fecha_creacion) }}
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Columna Descripci√≥n -->
      <ng-container matColumnDef="descripcion">
        <th mat-header-cell *matHeaderCellDef>Descripci√≥n</th>
        <td mat-cell *matCellDef="let element" class="description-cell">
          {{ element.descripcion ? (element.descripcion.substring(0, 80) + (element.descripcion.length > 80 ? '...' : '')) : 'Sin descripci√≥n' }}
        </td>
      </ng-container>

      <!-- Columna Estado -->
      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let element" class="status-cell">
          <div class="status-content">
            <div [class]="'status-badge ' + getEstadoInfo(element).badgeClass">
              <mat-icon>{{getEstadoInfo(element).icon}}</mat-icon>
              {{getEstadoInfo(element).label}}
            </div>
          </div>
        </td>
      </ng-container>

      <!-- üÜï NUEVA Columna SLA -->
      <ng-container matColumnDef="sla">
        <th mat-header-cell *matHeaderCellDef>SLA</th>
        <td mat-cell *matCellDef="let element" class="sla-cell">
          <div class="sla-container" *ngIf="element.estado">
            <div class="sla-progress">
              <div class="sla-progress-bar">
                <div 
                  class="sla-progress-fill"
                  [class]="'sla-' + getSlaInfo(element).estado.toLowerCase()"
                  [style.width.%]="getSlaInfo(element).porcentaje">
                </div>
              </div>
              <div class="sla-info">
                <div 
                  class="sla-badge"
                  [class]="'sla-' + getSlaInfo(element).estado.toLowerCase()">
                  <mat-icon>{{getSlaInfo(element).icono}}</mat-icon>
                  <span class="sla-text">{{getSlaInfo(element).texto}}</span>
                  <span class="sla-time" *ngIf="getSlaInfo(element).tiempoRestante">
                    {{getSlaInfo(element).tiempoRestante}}
                  </span>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!element.estado" class="sla-inactive">
            <span class="inactive-text">Eliminado</span>
          </div>
        </td>
      </ng-container>

      <!-- Columna T√©cnico -->
      <ng-container matColumnDef="tecnico">
        <th mat-header-cell *matHeaderCellDef>T√©cnico</th>
        <td mat-cell *matCellDef="let element" class="technician-cell">
          <div *ngIf="element.tecnico" class="technician-assigned">
            <div class="technician-name">{{ element.tecnico.nombre_usuario }}</div>
            <div class="technician-email">{{ element.tecnico.correo_electronico }}</div>
          </div>
          <div *ngIf="!element.tecnico" class="technician-unassigned">
            <span class="unassigned-text">No asignado</span>
          </div>
        </td>
      </ng-container>

      <!-- Columna Categor√≠a -->
      <ng-container matColumnDef="categoria">
        <th mat-header-cell *matHeaderCellDef>Categor√≠a</th>
        <td mat-cell *matCellDef="let element" class="category-cell">
          <div class="category-content">
            <div class="category-name">{{ element.categoria?.nombre || 'No asignada' }}</div>
            <div *ngIf="element.subcategoria" class="subcategory">
              {{ element.subcategoria.nombre }}
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Columna Prioridad -->
      <ng-container matColumnDef="prioridad">
        <th mat-header-cell *matHeaderCellDef>Prioridad</th>
        <td mat-cell *matCellDef="let element" class="priority-cell">
          <div *ngIf="element.prioridad" 
               [class]="'priority-badge ' + getPrioridadClase(element)">
            {{ element.prioridad.nombre }}
            <div class="priority-level">Nivel {{ element.prioridad.nivel }}</div>
          </div>
        </td>
      </ng-container>

      <!-- Columna Fecha -->
      <ng-container matColumnDef="fecha_creacion">
        <th mat-header-cell *matHeaderCellDef>Fecha Creaci√≥n</th>
        <td mat-cell *matCellDef="let element" class="date-cell">
          <div class="date-content">
            <div class="date">{{ element.fecha_creacion | date:'dd/MM/yyyy' }}</div>
            <div class="time">{{ element.fecha_creacion | date:'HH:mm' }}</div>
          </div>
        </td>
      </ng-container>

      <!-- Columna Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
        <td mat-cell *matCellDef="let element" class="actions-cell">
          <div class="actions-container">
            <!-- Conversaci√≥n -->
            <button 
              (click)="abrirConversacion(element)" 
              class="btn-action chat"
              matTooltip="Ver conversaci√≥n">
              <mat-icon>chat</mat-icon>
            </button>

            <!-- Asignar/Reasignar T√©cnico -->
            <button 
              (click)="asignarTecnico(element)" 
              class="btn-action assign"
              matTooltip="Asignar/Reasignar t√©cnico"
              [disabled]="!element.estado">
              <mat-icon>person</mat-icon>
            </button>

            <!-- Marcar Resuelto -->
            <button 
              *ngIf="getEstadoInfo(element).value !== 'RESUELTO' && getEstadoInfo(element).value !== 'CERRADO'"
              (click)="marcarResuelto(element)" 
              class="btn-action resolve"
              matTooltip="Marcar como resuelto"
              [disabled]="!element.estado">
              <mat-icon>check_circle</mat-icon>
            </button>

            <!-- Reabrir -->
            <button 
              *ngIf="getEstadoInfo(element).value === 'RESUELTO' || getEstadoInfo(element).value === 'CERRADO'"
              (click)="reabrirTicket(element)" 
              class="btn-action reopen"
              matTooltip="Reabrir ticket"
              [disabled]="!element.estado">
              <mat-icon>refresh</mat-icon>
            </button>

            <!-- Eliminar/Restaurar -->
            <button 
              *ngIf="element.estado; else restaurarBtn"
              (click)="delete(element.id)" 
              class="btn-action delete"
              matTooltip="Eliminar ticket">
              <mat-icon>delete</mat-icon>
            </button>

            <ng-template #restaurarBtn>
              <button 
                (click)="restaurar(element.id)" 
                class="btn-action restore"
                matTooltip="Restaurar ticket">
                <mat-icon>restore</mat-icon>
              </button>
            </ng-template>
          </div>
        </td>
      </ng-container>

      <!-- Filas -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row"></tr>
      <tr 
        mat-row 
        *matRowDef="let row; columns: displayedColumns;" 
        [class.deleted-row]="!row.estado"
        class="data-row">
      </tr>
    </table>

    <!-- Estados vac√≠os -->
    <div *ngIf="dataSource.data.length === 0" class="empty-state">
      <mat-icon class="empty-icon">support</mat-icon>
      <h3>No hay tickets</h3>
      <p>Los tickets aparecer√°n aqu√≠ cuando sean creados</p>
    </div>

    <div *ngIf="dataSource.filteredData.length === 0 && dataSource.data.length > 0" class="empty-state">
      <mat-icon class="empty-icon">search_off</mat-icon>
      <h3>No se encontraron resultados</h3>
      <p>Intenta con otros t√©rminos de b√∫squeda</p>
      <button 
        (click)="limpiarFiltros()"
        class="btn-primary">
        Limpiar Filtros
      </button>
    </div>
  </div>

  <!-- Paginador -->
  <mat-paginator 
    [pageSize]="10" 
    [pageSizeOptions]="[5, 10, 25, 50]"
    showFirstLastButtons
    class="paginator">
  </mat-paginator>
</div>